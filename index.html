<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>√öprava doch√°zky</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            padding: 16px;
            padding-bottom: 80px;
        }

        h1 {
            font-size: 24px;
            margin-bottom: 8px;
            color: var(--tg-theme-text-color, #000000);
        }

        .subtitle {
            font-size: 14px;
            color: var(--tg-theme-hint-color, #999999);
            margin-bottom: 24px;
        }

        .section {
            background-color: var(--tg-theme-secondary-bg-color, #f5f5f5);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--tg-theme-text-color, #000000);
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--tg-theme-text-color, #000000);
        }

        .date-input, .time-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--tg-theme-hint-color, #cccccc);
            border-radius: 8px;
            font-size: 16px;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
        }

        .attendance-item {
            padding: 12px;
            background-color: var(--tg-theme-bg-color, rgba(255, 255, 255, 0.5));
            border-radius: 8px;
            margin-bottom: 12px;
            border: 1px solid var(--tg-theme-hint-color, #e0e0e0);
        }

        .attendance-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .attendance-item-title {
            font-weight: 600;
            font-size: 14px;
        }

        .remove-btn {
            background-color: #ff3b30;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            font-weight: 500;
        }

        .add-btn {
            width: 100%;
            padding: 12px;
            background-color: var(--tg-theme-button-color, #0088cc);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 8px;
        }

        .time-row {
            display: flex;
            gap: 12px;
        }

        .time-row > div {
            flex: 1;
        }

        .break-item {
            padding: 10px;
            background-color: var(--tg-theme-secondary-bg-color, rgba(245, 245, 245, 0.5));
            border-radius: 6px;
            margin-bottom: 8px;
            border: 1px solid var(--tg-theme-hint-color, #e0e0e0);
        }

        .break-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .break-item-title {
            font-weight: 500;
            font-size: 13px;
        }

        .break-remove-btn {
            background-color: #ff9500;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
        }

        .empty-state {
            text-align: center;
            padding: 20px;
            color: var(--tg-theme-hint-color, #999999);
            font-size: 14px;
        }

        .info-text {
            font-size: 13px;
            color: var(--tg-theme-hint-color, #999999);
            margin-top: 8px;
            line-height: 1.4;
        }
    </style>
</head>
<body>
    <h1>üìÖ √öprava doch√°zky</h1>
    <p class="subtitle">Upravte z√°znamy p≈ô√≠chodu, odchodu a p≈ôest√°vek</p>

    <div class="section">
        <div class="section-title">üìÜ Datum</div>
        <div class="form-group">
            <label>Vyberte datum</label>
            <input type="date" class="date-input" id="datePicker">
        </div>
    </div>

    <div class="section">
        <div class="section-title">‚è∞ Z√°znamy doch√°zky</div>
        <p class="info-text">P≈ôidejte z√°znamy p≈ô√≠chodu a odchodu. K ka≈æd√©mu z√°znamu m≈Ø≈æete p≈ôidat p≈ôest√°vky.</p>
        <div id="attendanceList"></div>
        <button type="button" class="add-btn" id="addAttendanceBtn">+ P≈ôidat z√°znam</button>
    </div>

    <script>
        // Initialize Telegram WebApp
        let tg = window.Telegram?.WebApp;
        
        if (!tg) {
            console.error('Telegram WebApp not available');
            // Fallback for testing outside Telegram
            tg = {
                expand: () => {},
                MainButton: {
                    setText: () => {},
                    show: () => {},
                    enable: () => {},
                    disable: () => {},
                    onClick: () => {},
                    onEvent: () => {}
                },
                sendData: () => {},
                showAlert: (msg) => alert(msg),
                initDataUnsafe: {}
            };
        } else {
            tg.ready();
            tg.expand();
        }
        
        tg.MainButton.setText("Ulo≈æit doch√°zku");
        tg.MainButton.show();

        let attendanceRecords = [];
        let selectedDate = new Date().toISOString().split('T')[0];

        // Initialize date picker
        document.getElementById('datePicker').value = selectedDate;
        document.getElementById('datePicker').addEventListener('change', (e) => {
            selectedDate = e.target.value;
            loadAttendanceForDate(selectedDate);
        });

        function initializeForm() {
            // Try to get data from start_param (URL parameter or initData)
            let dataToLoad = null;
            
            // Check URL parameters first
            const urlParams = new URLSearchParams(window.location.search);
            const startParam = urlParams.get('start_param');
            
            if (startParam) {
                try {
                    dataToLoad = JSON.parse(decodeURIComponent(startParam));
                } catch (e) {
                    console.log('Failed to parse start_param from URL');
                }
            }
            
            // Fallback to initDataUnsafe
            if (!dataToLoad) {
                const initDataUnsafe = tg.initDataUnsafe;
                if (initDataUnsafe && initDataUnsafe.start_param) {
                    try {
                        dataToLoad = JSON.parse(decodeURIComponent(initDataUnsafe.start_param));
                    } catch (e) {
                        console.log('Failed to parse start_param from initData');
                    }
                }
            }
            
            // Load data if available
            if (dataToLoad) {
                if (dataToLoad.date) {
                    selectedDate = dataToLoad.date;
                    document.getElementById('datePicker').value = selectedDate;
                }
                if (dataToLoad.attendanceRecords && Array.isArray(dataToLoad.attendanceRecords)) {
                    attendanceRecords = dataToLoad.attendanceRecords;
                }
            }
            
            renderAttendance();
            validateForm();
            
            // Ensure button is enabled after initialization
            setTimeout(() => {
                validateForm();
            }, 100);
        }

        function loadAttendanceForDate(date) {
            // In a real implementation, this would fetch from the bot
            // For now, we'll just re-render with current data
            renderAttendance();
            validateForm();
        }

        function addAttendanceRecord() {
            attendanceRecords.push({
                id: Date.now(),
                clock_in: '09:00',
                clock_out: '17:00',
                breaks: []
            });
            renderAttendance();
            validateForm();
        }

        function removeAttendanceRecord(id) {
            attendanceRecords = attendanceRecords.filter(r => r.id !== id);
            renderAttendance();
            validateForm();
        }

        function addBreak(attendanceId) {
            const record = attendanceRecords.find(r => r.id === attendanceId);
            if (record) {
                record.breaks.push({
                    id: Date.now(),
                    start_time: '12:00',
                    end_time: '12:30'
                });
                renderAttendance();
                validateForm();
            }
        }

        function removeBreak(attendanceId, breakId) {
            const record = attendanceRecords.find(r => r.id === attendanceId);
            if (record) {
                record.breaks = record.breaks.filter(b => b.id !== breakId);
                renderAttendance();
                validateForm();
            }
        }

        function renderAttendance() {
            const container = document.getElementById('attendanceList');
            if (attendanceRecords.length === 0) {
                container.innerHTML = '<div class="empty-state">≈Ω√°dn√© z√°znamy doch√°zky</div>';
                return;
            }

            container.innerHTML = attendanceRecords.map((record, index) => `
                <div class="attendance-item" data-attendance-id="${record.id}">
                    <div class="attendance-item-header">
                        <span class="attendance-item-title">Z√°znam ${index + 1}</span>
                        <button type="button" class="remove-btn" onclick="removeAttendanceRecord(${record.id})">Odebrat</button>
                    </div>
                    <div class="time-row">
                        <div class="form-group">
                            <label>P≈ô√≠chod</label>
                            <input type="time" class="time-input clock-in-time" value="${record.clock_in}" data-attendance-id="${record.id}">
                        </div>
                        <div class="form-group">
                            <label>Odchod</label>
                            <input type="time" class="time-input clock-out-time" value="${record.clock_out}" data-attendance-id="${record.id}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>P≈ôest√°vky</label>
                        <div id="breaks-${record.id}">
                            ${record.breaks.map((breakItem, breakIndex) => `
                                <div class="break-item">
                                    <div class="break-item-header">
                                        <span class="break-item-title">P≈ôest√°vka ${breakIndex + 1}</span>
                                        <button type="button" class="break-remove-btn" onclick="removeBreak(${record.id}, ${breakItem.id})">Odebrat</button>
                                    </div>
                                    <div class="time-row">
                                        <div class="form-group">
                                            <label>Zaƒç√°tek</label>
                                            <input type="time" class="time-input break-start-time" value="${breakItem.start_time}" data-attendance-id="${record.id}" data-break-id="${breakItem.id}">
                                        </div>
                                        <div class="form-group">
                                            <label>Konec</label>
                                            <input type="time" class="time-input break-end-time" value="${breakItem.end_time}" data-attendance-id="${record.id}" data-break-id="${breakItem.id}">
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <button type="button" class="add-btn" onclick="addBreak(${record.id})" style="margin-top: 8px; font-size: 13px; padding: 8px;">+ P≈ôidat p≈ôest√°vku</button>
                    </div>
                </div>
            `).join('');

            attachListeners();
        }

        function attachListeners() {
            // Clock in/out time changes
            document.querySelectorAll('.clock-in-time, .clock-out-time').forEach(input => {
                input.addEventListener('change', (e) => {
                    const attendanceId = parseInt(e.target.dataset.attendanceId);
                    const record = attendanceRecords.find(r => r.id === attendanceId);
                    if (record) {
                        if (e.target.classList.contains('clock-in-time')) {
                            record.clock_in = e.target.value;
                        } else {
                            record.clock_out = e.target.value;
                        }
                        validateForm();
                    }
                });
            });

            // Break time changes
            document.querySelectorAll('.break-start-time, .break-end-time').forEach(input => {
                input.addEventListener('change', (e) => {
                    const attendanceId = parseInt(e.target.dataset.attendanceId);
                    const breakId = parseInt(e.target.dataset.breakId);
                    const record = attendanceRecords.find(r => r.id === attendanceId);
                    if (record) {
                        const breakItem = record.breaks.find(b => b.id === breakId);
                        if (breakItem) {
                            if (e.target.classList.contains('break-start-time')) {
                                breakItem.start_time = e.target.value;
                            } else {
                                breakItem.end_time = e.target.value;
                            }
                            validateForm();
                        }
                    }
                });
            });
        }

        function validateForm() {
            // Allow saving even with no records (to clear them)
            if (attendanceRecords.length === 0) {
                tg.MainButton.enable();
                return;
            }

            let isValid = true;

            attendanceRecords.forEach(record => {
                // Validate clock times
                if (!record.clock_in || !record.clock_out) {
                    isValid = false;
                } else {
                    // Check clock_out > clock_in
                    const clockIn = record.clock_in.split(':');
                    const clockOut = record.clock_out.split(':');
                    const inMinutes = parseInt(clockIn[0]) * 60 + parseInt(clockIn[1]);
                    const outMinutes = parseInt(clockOut[0]) * 60 + parseInt(clockOut[1]);
                    
                    if (outMinutes <= inMinutes) {
                        isValid = false;
                    }
                }

                // Validate breaks
                if (record.breaks && record.breaks.length > 0) {
                    record.breaks.forEach(breakItem => {
                        if (!breakItem.start_time || !breakItem.end_time) {
                            isValid = false;
                        } else {
                            const breakStart = breakItem.start_time.split(':');
                            const breakEnd = breakItem.end_time.split(':');
                            const startMinutes = parseInt(breakStart[0]) * 60 + parseInt(breakStart[1]);
                            const endMinutes = parseInt(breakEnd[0]) * 60 + parseInt(breakEnd[1]);
                            
                            if (endMinutes <= startMinutes) {
                                isValid = false;
                            }

                            // Check break is within attendance period
                            if (record.clock_in && record.clock_out) {
                                const clockIn = record.clock_in.split(':');
                                const clockOut = record.clock_out.split(':');
                                const inMinutes = parseInt(clockIn[0]) * 60 + parseInt(clockIn[1]);
                                const outMinutes = parseInt(clockOut[0]) * 60 + parseInt(clockOut[1]);
                                
                                if (startMinutes < inMinutes || endMinutes > outMinutes) {
                                    isValid = false;
                                }
                            }
                        }
                    });
                }
            });

            if (isValid) {
                tg.MainButton.enable();
            } else {
                tg.MainButton.disable();
            }
        }

        function collectFormData() {
            // Update all values from inputs
            attendanceRecords.forEach(record => {
                const clockInInput = document.querySelector(`.clock-in-time[data-attendance-id="${record.id}"]`);
                const clockOutInput = document.querySelector(`.clock-out-time[data-attendance-id="${record.id}"]`);
                
                if (clockInInput) record.clock_in = clockInInput.value;
                if (clockOutInput) record.clock_out = clockOutInput.value;

                record.breaks.forEach(breakItem => {
                    const startInput = document.querySelector(`.break-start-time[data-attendance-id="${record.id}"][data-break-id="${breakItem.id}"]`);
                    const endInput = document.querySelector(`.break-end-time[data-attendance-id="${record.id}"][data-break-id="${breakItem.id}"]`);
                    
                    if (startInput) breakItem.start_time = startInput.value;
                    if (endInput) breakItem.end_time = endInput.value;
                });
            });

            return {
                date: selectedDate,
                attendanceRecords: attendanceRecords.map(r => {
                    // Only include id if it's a database ID (not a temporary Date.now() ID)
                    const record = {
                        clock_in: r.clock_in,
                        clock_out: r.clock_out,
                        breaks: (r.breaks || []).map(b => ({
                            start_time: b.start_time,
                            end_time: b.end_time
                        }))
                    };
                    
                    // Only include id if it looks like a database ID (smaller number)
                    // Temporary IDs from Date.now() are very large, database IDs are smaller
                    if (r.id && r.id < 1000000000) {
                        record.id = r.id;
                    }
                    
                    return record;
                })
            };
        }

        document.getElementById('addAttendanceBtn').addEventListener('click', addAttendanceRecord);

        tg.MainButton.onClick(() => {
            try {
                const formData = collectFormData();
                console.log('Sending attendance data:', formData);
                
                // Show loading state
                tg.MainButton.setText("Ukl√°d√°m...");
                tg.MainButton.disable();
                
                tg.sendData(JSON.stringify(formData));
                
                // Reset button after a delay (in case of error)
                setTimeout(() => {
                    tg.MainButton.setText("Ulo≈æit doch√°zku");
                    validateForm();
                }, 3000);
            } catch (error) {
                console.error('Error sending data:', error);
                tg.showAlert('Chyba p≈ôi odes√≠l√°n√≠ dat: ' + error.message);
                tg.MainButton.setText("Ulo≈æit doch√°zku");
                validateForm();
            }
        });

        // Handle errors from Telegram WebApp
        tg.onEvent('viewportChanged', () => {
            tg.expand();
        });

        initializeForm();
    </script>
</body>
</html>

